# メニュー機能

Ver1では、一年分のカレンダーが縦方向にズラーっと並ぶ形だったので、これを見たい月のカレンダーだけを見る形に変更したいと思います。また、キー入力によるカレンダー切り替えを可能にしたいと思います

- 変更前：縦方向に1月から12月までを縦に列挙
- 変更後：当月カレンダーを表示し、その下に祝日及びメニュー表示

こういったユーザーインターフェース(UI)にまつわる変更を行う際には、事前に画面イメージを作っておくと良いでしょう。

## ポイント

メニュー操作を実装する際にポイントとなるのが、

- ユーザーの入力をどうやってシステムに反映させるか？

例えば、カレンダーであればユーザー入力として発生するのは

- 更新したい「年」「月」
  - カレンダー描画処理に年月を渡してカレンダー出力を行う
- アプリケーション終了要求
  - 必要な終了処理を行ってアプリケーションを終了する

でしょう。

慣れない内は、こういったポイントの見極めが上手くいかず、入力と描画処理の分離がマズイ為に実装コードがゴチャゴチャになってしまう事も多いと思います。こういったコードは全体の見通しが悪く、また仕様変更にも弱くなってしまいます。とはいえ、何事も知識と経験ですので、失敗と反省を繰り返して良い設計を学んで下さい

## UI要素別の解説

画面描画として必要な機能は主に以下の4点です。カレンダー出力はVer1のものをそのまま流用出来るので、それ以外の項目について順番に説明します

- トップメニュー表示
- 画面クリア
- 入力操作一覧表示
- カレンダー出力

### トップメニュー表示

従来のカレンダー処理への入力情報として必要なのは年月情報でした。ここでは、外部変数としてyear_/month_という変数を用いて、従来のカレンダー処理へのパラメータとする事にします。先ずはソースコードを示します

```cpp
bool
PrintMenu( void )
{
    ClearScreen(); // 画面表示をクリアする
    printf(
        "表示年月日を入力して下さい\n"
        "ex) 2019 2\n"
        "> "
    );

    char input_buffer[ 256 ];
    fgets( input_buffer, sizeof( input_buffer ), stdin );
    int input_value_count = sscanf( input_buffer, "%d %d", &year_, &month_ );

    // 入力値チェック
    bool success = true; // 先ずは入力成功に設定しておく
    if( input_value_count != 2 )// 入力値が2になっている？
    {
        success = false;
    }
    // 年は1から9999の値が指定されている？
    if( ( year_ <    1 ) || // 年が   1より小さい？
        ( year_ > 9999 ) )  // 年が9999より大きい？
    {
        success = false;
    }
    // 月は1から12の値が指定されている？
    if( ( month_ <  1 ) || // 月が 1より小さい？
        ( month_ > 12 ) )  // 月が12より大きい？
    {
        success = false;
    }
    if( !success )
    {
        printf( "入力に誤りがあります。もう一度入力して下さい\n" );
    }

    return success;
} // PrintMenu()
```

ある程度は処理の内容が分かるようになっていると思いますが、肝心な年月入力の部分がややこしいですね。キー入力処理としては比較的無難な方法なので、説明しておきます。

```cpp
char input_buffer[ 256 ];
fgets( input_buffer, sizeof( input_buffer ), stdin );
int input_value_count = sscanf( input_buffer, "%d %d", &year_, &month_ );
```

ここで行っている処理は以下のようなものです

- ユーザー入力を入れる為の変数(input_buffer)を用意する
- fgets()関数でユーザー入力を受け付ける。この関数のパラメータ仕様は概ね以下の通り
  - 第1引数：入力受付先の変数
  - 第2引数：入力を受け付ける最大サイズ(入力変数のサイズを超えなければOK)
  - 第3引数：入力元。主に以下の値が使われます
    - stdin：キーボードからの入力
    - ファイルポインタ：ファイルからの入力
- sscanf()関数で、input_bufferからyear_とmonth_変数に値を入れる。

### 画面クリア

画面のクリアにはいくつかの方法があります

- エスケープシーケンス
- コマンドプロンプトのコマンドを呼び出す

前者は入門コードとして紹介されるHello Worldにも表れます

```cpp
printf( "Hello world!!\n" ); // \nがエスケープシーケンス
```

これを使って画面クリアを行う場合、以下のように書きます

```cpp
printf("¥033[2J"); // 画面クリア
```

…分かりにくいですね。ただ、やり方を知ると描画処理の幅が大きく広がるので是非とも調べて使えるようになって欲しい所ではあります。

もう一つの**コマンドプロンプトのコマンドを利用する**方法ですが、画面出力の際に表示されるウインドウは、コンソールウインドウと呼ばれます。この中ではWindows標準アクセサリのコマンドプロンプトで使える機能であれば、そのまま利用する事が出来ます。例えばコマンドプロンプトで以下のようにclsコマンドを実行すれば画面クリアを行う事が出来ます

```
C:\>cls
```

C言語でこのような処理を行うにはsystem()関数を使用します

```cpp
system( "cls" );
```

こっちの方が少し分かりやすいですかね。

### 入力操作一覧表示

先ずは入力操作として受け付けられる機能を検討する必要があります。ここでは、以下のようなキー入力を受け付けられる事としました。

| キー           | 機能                         | 備考                            |
| -------------- | ---------------------------- | ------------------------------- |
| カーソルキー上 | 1年前のカレンダーを表示      | 0年以下の入力は受け付けない     |
| カーソルキー下 | 1年後のカレンダーを表示      | 10000年以上の入力は受け付けない |
| カーソルキー左 | 1ヶ月前のカレンダーを表示    | 0月以下の入力は受け付けない     |
| カーソルキー右 | 1ヶ月後のカレンダーを表示    | 13月以上の入力は受け付けない    |
| q              | アプリケーション終了         | quitの略                        |
| c              | 任意の年月のカレンダーを表示 |                                 |

メニュー表示部分のコードを紹介します

```cpp
bool
ChangeCalendar()
{
    printf(
        "=======================================\n"
        "↑ : 去年のカレンダーを表示\n"
        "↓ : 来年のカレンダーを表示\n"
        "→ : 次月のカレンダーを表示\n"
        "← : 先月のカレンダーを表示\n"
        "c  : 指定年月のカレンダーを表示\n"
        "Q  : カレンダー表示を終了する\n"
        "=======================================\n"
    );
```

### キー入力受付

描画が出来たら、今度はユーザーからの操作を受け付けられるようにします。キー入力受付制御は微妙にややこしくて、大きく分けて以下の２パターンの受付方法があります

- 入力後のEnterキーで受け付ける(C言語標準として定義されている)
- 入力をそのまま受け付ける(C言語非標準)

前者のやり方は既にトップメニュー表示の時に扱っていますね。ここでは**年月を進める度にEnterキーを要求される**のは大変煩わしいので、後者のやり方で処理する事にします。

後者の場合、何かのキー入力に対してキーコードが発生するので、それをプログラムで受けて、キーコード別の処理を行う事で制御します。しかし、少し面倒な事に「一つのキー入力に対して２回のキーコードが発行される」ケースがあり、ずばり今回使用するカーソルキーがそれだったりします。なので、毎回何も考えずキーコードを２回取得するようにしています。

```cpp
    bool request_quit = false;
    int key_1st = _getch();
    int key_2nd = _getch();
    switch( key_1st )
    {
    case 'q':
        request_quit = true;
        break;

    case 'c':
        PrintMenu();
        break;

    case 0xE0:
        cursor_key_proc( key_2nd );
        ClearScreen();
        break;
    }

    return request_quit;
} // ChangeCalendar()
```

キーコード取得にはconio.hヘッダのインクルードと、_getch()関数を使います。また、アンダースコア始まりの関数という事からも分かる通り少し特殊な扱いの関数となります。余談ですが、C言語の定義として**アンダースコア始まりの関数は処理系定義のもの**として扱われます。すなわち、プログラマは**アンダースコア始まりの変数や関数を定義する事は禁忌である**という事を覚えておいて下さい。(困った事に、このルールを知らないでコードを書いてしまう人が驚く程に多いのです)

カーソルキー入力が行われると「0xE0」というキーコードの後に、もう一つキーコードが続くので、更に処理を分岐させる必要があります。ここではcursor_key_proc()という関数で2つ目のキーコードを処理しています。この時、年月の入力値制限も一緒に行っている事に注目して下さい

```cpp
void
cursor_key_proc( int key )
{
    switch( key )
    {
    case 0x50: // "↓"
        if( year_ < END_OF_YEAR )
            year_++;
        break;
    case 0x48: // "↑"
        if( year_ > 1 )
            year_--;
        break;
    case 0x4D: // "→"
        if( month_ < END_OF_MONTH )
            month_++;
        break;
    case 0x4B: // "←"
        if( month_ > 1 )
            month_--;
        break;
    }
} // CalendarControler::cursor_key_proc()
```

